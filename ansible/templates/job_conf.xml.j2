<?xml version="1.0"?>
<job_conf>
    <plugins workers="2">
        <plugin id="local" type="runner" load="galaxy.jobs.runners.local:LocalJobRunner"/>
        <plugin id="pulsarMQ" type="runner" load="galaxy.jobs.runners.pulsar:PulsarMQJobRunner">
            <!-- Must tell Pulsar where to send files. -->
            <param id="galaxy_url">{{ galaxy_instance_url }}</param>
            <!-- Message Queue Connection (should match message_queue_url in Pulsar's app.yml) -->
            <param id="amqp_url">{{ message_queue_url }}</param>
        </plugin>
    </plugins>
    <destinations default="singularity_remote_cluster_MQ">
        <destination id="local" runner="local"/>
        <destination id="singularity_local" runner="local">
            <expand macro="dest_tmp_env" />
            <param id="singularity_enabled">true</param>
            <param id="singularity_volumes">$defaults</param>
            <param id="singularity_default_container_id">/cvmfs/singularity.galaxyproject.org/u/b/ubuntu:18.04</param>
        </destination>
        <destination id="docker_remote_cluster_MQ" runner="pulsarMQ">
            <param id="docker_enabled">true</param>
            <param id="docker_volumes">$defaults</param>
            <expand macro="dest_tmp_env" />
            <expand macro="dest_pulsar_common_params" />
        </destination>
        <destination id="singularity_remote_cluster_MQ" runner="pulsarMQ">
            <param id="singularity_enabled">true</param>
            <param id="singularity_volumes">$defaults</param>
            <param id="singularity_default_container_id">/cvmfs/singularity.galaxyproject.org/u/b/ubuntu:18.04</param>
            <expand macro="dest_tmp_env" />
            <expand macro="dest_pulsar_common_params" />
        </destination>
        <destination id="conda_remote_cluster_MQ" runner="pulsarMQ">
            <expand macro="dest_tmp_env" />
            <expand macro="dest_pulsar_common_params" />
        </destination>
    </destinations>
    <tools>
        <tool id="upload1" destination="local" />
        <tool id="toolshed.g2.bx.psu.edu/repos/iuc/snpeff/snpEff_download/4.1.0" destination="local" />
        <tool id="toolshed.g2.bx.psu.edu/repos/iuc/snpeff/snpEff_download/4.3r.1" destination="local" />
    </tools>
    <macros>
        <xml name="dest_tmp_env">
            <env id="TEMP">$(dirname ${BASH_SOURCE[0]})/_job_tmp</env>
            <env id="TMPDIR">$TEMP</env>
            <env id="_JAVA_OPTIONS">-Djava.io.tmpdir=$TEMP</env>
            <env exec="mkdir -p $TEMP" />
        </xml>
        <xml name="dest_pulsar_common_params">
            <param id="transport">curl</param>
            <param id="remote_metadata">false</param>
            <param id="default_file_action">remote_transfer</param>
            <param id="dependency_resolution">remote</param>
            <param id="jobs_directory">{{ pulsar_jobs_directory }}</param>
            <param id="amqp_acknowledge">True</param>
            <param id="persistence_directory">/data/share/persisted_data</param>
            <param id="amqp_ack_republish_time">30</param>
            <param id="manager">_default_</param>
            <env id="LC_ALL">C</env>
        </xml>
    </macros>
</job_conf>
